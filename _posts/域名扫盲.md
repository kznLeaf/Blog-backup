---
title: 域名的基础知识、域名劫持和域名污染
date: 2025-06-22 18:43:15
index_img:
tags:
  - 计网
categories: Computer Networking
---

本文是对[扫盲 DNS 原理，兼谈“域名劫持”和“域名欺骗/域名污染”](https://program-think.blogspot.com/2014/01/dns.html)的整理，在原文的基础上加上一些注解。感谢编程随想。

HTTPS SSL/TLS 扫盲见链接： https://program-think.blogspot.com/2014/11/https-ssl-tls-0.html

## 域名解析的实现过程

如果你曾经配置过电脑的网卡，应该记得上面除了有 IP 地址、掩码等设置，还有一项设置是“DNS 服务器/域名服务器”。这项设置就是用来帮助你的电脑进行域名解析的。你可以把这个“DNS 服务器”想象成114查号台。每当电脑需要翻译某个域名，就找这个域名服务器查询，然后域名服务器会告诉你的电脑，要查询的域名对应的IP地址是啥。

下面简单说一下，你的电脑进行域名解析的过程。
为了叙述方便，以俺博客为例。当你在浏览器的地址栏中输入 https://program-think.blogspot.com/ 然后敲回车，这时候电脑软件会进行如下一系列事情。

1. 首先根据输入的网址，提取出域名（在本例中，也就是 program-think.blogspot.com）
2. 如果你在系统中配置了 **Hosts** 文件，那么电脑会先查询 Hosts 文件，看这个 program-think.blogspot.com 是否已经在 Hosts 里面有了对应的记录。如果有，直接就可以拿到该记录中的 IP 地址，过程就结束了。
3. 如果 Hosts 里面没有这个别名，那么电脑会看你有没有设置**域名服务器**（DNS 服务器）。如果你的系统没有设置域名服务器，那电脑就没辙了，浏览器直接会报错，说网站的域名无法解析。过程就结束了。
4. 如果你设置过“域名服务器”，那么电脑会向这个域名服务器发送一个**域名查询**（DNS query）的请求，然后等候域名服务器的回应。
5. 如果域名服务器始终没有回应（比如域名服务器挂了，或域名服务器的 IP 填错了，或请求被 GFW 拦截了），那么电脑还是没辙（浏览器会报错）。
6. 如果域名服务器回应了，那么你的电脑就可以根据域名服务器的应答信息，得到该域名的 IP 地址。之后浏览器就会向这个 IP 地址对应的 Web 端口发送 HTTP 请求。

通常情况下，电脑拿到的（DNS 服务器）应答信息是正确的——也就是说，应答中的 IP 地址确实对应那个域名——这种情况下，你的网络软件就可以正常工作了。

但是在天朝这个奇葩的国家，电脑拿到的 DNS 应答有可能是【错的】。为啥会这样捏，本文的后半部，俺会介绍一下“**域名劫持**”和“**域名污染**”。

## 递归服务器

刚才提到的“域名服务器”其实是“递归服务器”（Recursive DNS Server）。递归服务器，就是你本地电脑或路由器在访问网站（如 www.baidu.com）时，第一时间请求的 DNS 服务器。
它的作用是：**帮你一步一步地找到最终的 IP 地址**，就像跑腿员一样去问别人。

- 用户：请问`www.example.com`的 IP 地址是多少？
  - 递归服务器：不知道，我帮你去打听打听
- 递归服务器问根服务器
  - 根服务器：这个域名位于`.com`顶级域服务器，它的 IP 地址是。。
- 递归服务器继续问`.com`顶级域服务器
  - 回答：你应该去找`example.com`的权威服务器，它的 IP 地址是。。
- 递归服务器问权威服务器
  - 回答：`www.example.com`的 IP 地址是。。。

> 上面提到了权威服务器。所谓权威服务器，其实就是直接掌管域名与 IP 的映射信息（A记录、MX记录、CNAME等）的服务器，也就是域名解析服务提供分配给你、用于添加各种记录的的服务器。



## 域名的缓存

因为递归服务器的查询效率很低，所以递归服务器必须有一个缓存。当某台电脑向递归服务器发起域名查询时，递归服务器首先看自己的缓存中有没有该域名的记录，如果有，直接就回复该记录给查询的电脑。如果没有，再执行上面的查询过程。

因为互联网上的域名信息是有可能发生变化的，比如增加了某个新域名，注销了某个旧域名，或者某个域名对应的 IP 地址变了。所以，“**递归服务器**”上保留的**缓存**中，每一条域名记录都有一个生命周期（可能是几分钟，也可能是几小时）。如果某条记录的生命周期过了，就会被删除，然后重新同步。

> 补充：DNS 缓存的位置有很多，例如：本地操作系统缓存表、浏览器缓存、家用路由器缓存、以及递归 DNS 服务器缓存。

## 域名劫持

### 什么是域名劫持

刚才说了，域名服务器上都会保存一大堆的域名记录（每条记录包含“域名”和“IP地址”）。当收到域名查询的时候，域名服务器会从这堆记录中找到对方想要的，然后回应给对方。 

如果域名服务器上的某条记录被【**人为修改**】了（改成错的），那么一旦要查询这条记录，得到的就是错误的结果。这种情况称之为“**域名劫持**”（DNS hijacking）。

> 
> 域名劫持（DNS hijacking）通常是指攻击者篡改了DNS解析链条中某个关键环节的记录，导致用户访问某个域名时被导向了错误甚至恶意的IP地址。具体来说，劫持可能发生在以下几类域名服务器上的记录被篡改：
>
> - 权威服务器。攻击者入侵权威服务器并修改某个域名的 A 记录、CNAME 等，从根源上篡改，这时最严重的劫持，影响所有查询该域名的用户。
> - 递归 DNS 服务器的缓存被篡改，也叫**DNS 缓存污染**。攻击者可以通过“**缓存投毒**”（DNS cache poisoning）攻击，向递归服务器注入伪造的 DNS 记录。这样，当用户通过该递归服务器查询域名时，得到的是伪造的错误IP。影响使用该递归服务器的用户。
> - 本地 hosts 文件或本地 DNS 解析配置被篡改。恶意软件可以篡改用户本地的 hosts 文件。只影响用户本机。
> - 中间代理被篡改。代理 DNS 服务器的记录被篡改，影响使用该代理服务器的所有用户。

### 谁干的

　“域名劫持”通常是**电信运营商**（ISP）干的好事儿。很多宽带用户用的域名服务器就是 ISP 提供给你的。而天朝的 ISP 也是很奇葩的——经常耍流氓。

举例：  前几年曾经出现过：某个 ISP 跟百度勾结，把谷歌的流量重定向到百度。具体搞法是：该 ISP 篡改自己的域名服务器的记录，把里面跟 google.com 相关的域名记录的 IP 地址修改为百度服务器的 IP 地址。如此一来，假设你用的是这个 ISP 的域名服务器，当你在浏览器输入 www.google.com 的时候，你的电脑查询到的 IP 地址其实是百度的 IP 地址，所以浏览器打开的是“百度”的主页。（这就属于权威服务器的域名劫持，最严重的一种情况）

### 如何应对

刚才说了，“域名劫持”的根源在于：域名服务器上的记录被人给改了。要对付这种耍流氓，最直接的办法就是不要使用这种流氓 ISP 提供的域名服务器，改用国外那些比较靠谱的。目前口碑最好的，大概是 Google 提供的两个域名服务器，IP 地址分别是 8.8.8.8 和 8.8.4.4 ——这俩不光是地址好记，更重要的是，不会耍流氓搞劫持。


## 域名污染

定义：**专指攻击者通过向递归DNS服务器注入伪造的错误DNS记录，使该递归服务器缓存了错误的解析结果**。是一种域名劫持的具体手段。

> WIKI: 
> 
> 网域服务器缓存污染（英语：**DNS cache pollution**）、**DNS污染或DNS劫持**，是一种破坏域名系统查询解析的行为，通常由计算机程序自动执行，从而导致 DNS 服务器缓存错误记录，又称域名服务器缓存投毒（DNS cache poisoning）和 DNS 缓存投毒。污染一词可能取自域名系统域名解析之特性，若递归DNS解析器查询上游时收到错误回复，所有下游也会受影响。
> 
> 这些篡改可能是出于恶意目的，例如网络钓鱼；也可能是出于**互联网服务提供商**（ISP）的自身目的，例如**防火长城**以及公共或路由器提供的 DNS 服务提供商将用户的网络流量引导至 ISP 自己的 web 服务器，以便投放广告、收集统计数据或实现ISP的其他目的（**引流**）；还可能是DNS服务提供商为了阻止对特定域名的访问而采取的一种**审查**形式。

---

“域名污染”的原理，简单说来是这样滴：当你的电脑向域名服务器发送了“域名查询”的请求，然后域名服务器把回应发送给你的电脑，这里存在一个【**时间差**】。如果某个攻击者能够在域名服务器的“ DNS 应答”还没有到达你的电脑之前，先伪造一个错误的“DNS 应答”发给你电脑。那么你的电脑收到的就是错误的信息，并得到一个错误的 IP 地址。

## GFW 的域名污染

GFW部署在天朝互联网的国际出口，三板斧：

1. **DNS 污染**
2. **IP 封锁**，采用黑名单机制
3. **敏感词过滤**，GFW 维护一个很长的敏感词列表，如果你的网站中包含**任何一个**敏感词，GFW 会通过技术手段屏蔽该页面

GFW 有两种污染方式：直接污染，间接污染。使用国外的域名服务器会受到直接污染，使用国内的域名服务器会受到间接污染。

### GFW 的部署位置

天朝的互联网只有少数几个**国际出口**（名气较大的是：北京出口、上海出口、广州出口）。如果你要访问天朝之外的网站，你的网络数据流就必定会经过其中的某个“国际出口”。而天朝的【**每一个**】国际出口都部署了 GFW 的设备。

### GFW 直接污染

因为 GFW 部署在天朝的【国际出口】。如果你用的是**国外的域名服务器**，你的“ DNS 请求”必定会经过国际出口；同样，域名服务器的“ DNS 应答”必定也会经过国际出口才能到你的电脑。这一来一回就给 GFW 提供了耍流氓的机会。

### GFW 间接污染

1. 你用的是国内的域名服务器，想访问某个被大陆封杀的网站。
2. 被封杀的网站，它的权威服务器肯定在国外
3. 当你向国内的DNS服务器查询的时候，这个DNS服务器需要从国外进行域名查询
4. **正是因为从国外进行域名查询，所以相关的数据流必定会经过国际出口，一旦经过国际出口，必定会被 GFW 污染**
5. 所以 DNS 服务器返回的是被污染的域名记录，而且，**国内的DNS服务器会把这条错误的记录缓存下来**。
6. 于是乎~如果以后还有人查询这个域名，也会得到错误的结果

上述过程不断重复，最终会导致：全国所有的域名服务器，它们的缓存中只要是包含了那个反共网站的记录，记录中的“IP 地址”必定是错的（这个错误的“IP 地址”也就是 GFW 伪造的那个）。所以说“间接污染”是很牛逼滴——可以把错误的域名记录扩散到全国。

刚才俺说了，“域名污染”也叫“域名缓存投毒”。**“投毒”一词真的非常形象——就好象在某条河流的【源头】下毒，从而把整条河流的水都污染**。在互联网时代搞“域名污染”是非常卑鄙下流的做法。因为 DNS 是互联网的基础设施，**而“域名污染”直接破坏了互联网的基础设施**。

### 如何应对域名污染/域名欺骗

下面这篇教程介绍了四种新的域名协议，有效对抗GFW。

https://program-think.blogspot.com/2018/10/Comparison-of-DNS-Protocols.html

