---
title: Valkey/Redis 如何通过多线程达到单点 1M RPS?
tags:
  - 中间件
date: 2025-09-04 22:37:06
index_img: https://s21.ax1x.com/2025/08/22/pVDDgxg.png
categories: Redis
---

Redis 的核心是单线程处理客户端的 SET/GET 请求，但现在大多数机器都是**多核**的。为了利用到多核，减少单线程成为瓶颈，AWS 为自己的 ElasticCache 做了很多改进，包括：（均已合并到Valkey 8.0）
- 2019年推出IO线程，承担一部分主线程的工作
- 2021年进一步优化IO线程，将开启 TLS 的集群加解密和连接处理操作从主线程移到 IO 线程
- 2023年推出增强的IO多路复用
- 2023年提出表示层卸载和内存访问摊销技术，实现单节点处理超过100万RPS。

## 增强I/O处理

增强的 I/O 多路复用可显著改善大规模吞吐量和延迟。先看看以前的IO多路复用是怎么做的：

![](https://s21.ax1x.com/2025/08/22/pVDDBVI.png)

每个客户端都与单线程的处理引擎建立一个连接通道，因此引擎要单独为每一个客户端的建立网络连接、解析发来的请求、运行解析出来的命令。这样的架构有两个问题：

1. **处理引擎必须亲自处理网络连接，必须亲自解析命令，不能专注于运行命令**
2. **多余的CPU核心没有得到利用**

为了解决这几个问题，增强型的IO多路复用使用以下架构：

![](https://s21.ax1x.com/2025/08/22/pVDDgxg.png)

其余可用的 CPU 核心用来分担主线程的压力，**把处理网络IO的工作转移到 IO 线程上**，主线程负责给IO线程分配任务。使用多路复用时，每个增强型 I/O 线程不会为每个客户端打开一个通道（如上图所示），而是**多个客户端共用一个IO线程**，由IO线程把收集到的命令通过单个通道发送给主线程处理。

这样做带来了哪些好处？具体来说：

1. 增强型 I/O 多路复用将源自多个客户端（有时是数千个）的命令组合到少量通道中，在相同连接数下通道的数量更少，提高了吞吐量。
2. 通道数量的减少增加了**访问局部性**，从而提高了内存缓存的使用率。
3. 缓存的命中率提高，于是命令的平均执行时间减少，降低了延迟。

## 表示层卸载

7.1 版本引入表示层卸载（Redis presentation layer offloading），指的是客户端命令的解析操作。增强型 IO 多路复用把网络IO的处理交给了单独的IO线程，而**表示层卸载在此基础上更进一步，让 IO 线程顺便把客户端的命令解析为 Redis 二进制命令的格式，然后转发到主线程进行**。这样有两个好处：

1. 多个CPU**并行**处理网络 IO 和解析命令的工作，充分利用到每一个CPU核心，大大提升执行效率
2. 主线程只需要专注于运行命令，提高了命令的执行效率



![表示层卸载](https://s21.ax1x.com/2025/08/22/pVDDTiV.png)

## 内存访问摊销

内存访问摊销（Memory access amortization）是为了解决随机内存访问开销过大的问题，旨在降低内存访问成本，降低延迟。在7.1版本引入。

Redis执行命令时经常需要通过字典去寻找key，对于需要查找多个key的情况，传统的做法是一个一个找，找完一个再重新访问内存寻找下一个，换句话说**哈希表遍历将串行运行**。而内存访问摊销采用的方式如下：

![](https://s21.ax1x.com/2025/08/22/pVDrv6g.png)

分析：

- **并行访问内存**，通过 **dictPrefetch** 机制，将多个 IO 线程的读取请求合并到一起并行处理，并把结果放到主线程对应 CPU 核的 L1/L2 私有缓存中，减少了 Redis 主线程针对每个命令都要进行内存调用的消耗，提高了性能。

## 主从复制优化

在 Valkey/Redis 进行主、从节点同步的时候，有时需要进行全量同步操作。比如有新的从节点加入，或者从节点和主节点复制延迟过大而主节点记录变更 buffer 没有全部更新数据时，都会触发新的全量同步操作。Valkey 8.0 通过**双通道传输**的机制，优化了全量同步，在某些情况下能降低 50% 全量同步的时间，并减少 60% 的复制数据内存。

全量同步时，主节点会生成 RDB 文件，同时会将生成 RDB 过程中的【增量更改信息】存储在专门的 **client output buffer** 中。RDB 生成完毕后，主节点会将 RDB 文件传输给从节点，从节点拿到 RDB 文件并 apply 后，会继续从主节点读取 client output buffer 中的**增量日志**。Valkey 7.2/Redis 在生成 RDB 文件过程中采用的 Copy-on-Write 的机制，即先 fork 一个进程，指向相同的内存空间。在生成 RDB 文件过程中，如果前端应用修改了部分数据，Valkey/Redis 会对修改的数据页进行一个拷贝，并在拷贝上进行修改。因此，全量同步的时间会影响 Redis 主节点的性能。

Valkey 8.0 提出了**双通道复制机制**来分别复制 RDB 和增量日志，同时将 client output buffer 放到从节点。这样的改进使得主节点在进行 RDB 文件生成的过程中，就可以将增量日志发送给从节点，**将顺序传输的方式改成了并行传输**，加快了同步速度。此外，从节点存放 client output buffer，能够释放写节点的资源，避免 buffer 过载，并使主节点更好地应对前端应用的负载。另外，同步速度加快，也能减少 buffer 自身的大小，同时减少主节点 COW 的时间，降低对前端应用的影响。






